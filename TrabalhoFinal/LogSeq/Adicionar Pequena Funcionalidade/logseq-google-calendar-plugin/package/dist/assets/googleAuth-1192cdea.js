const u="gcal_plugin_token",f="508606726652-m5ur12clr57fokgr37a95r87eo4tqua3.apps.googleusercontent.com",p="http://localhost:5173/oauth2callback.html",_=["https://www.googleapis.com/auth/calendar"],m="http://localhost:3000/exchange";function y(o){const t=new Uint8Array(o);let n="";for(let e=0;e<t.byteLength;e++)n+=String.fromCharCode(t[e]);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function S(o){const n=new TextEncoder().encode(o);return await crypto.subtle.digest("SHA-256",n)}function k(){const o=new Uint8Array(64);return crypto.getRandomValues(o),y(o.buffer)}async function b(o){const t=await S(o);return y(t)}async function w(o){const t=o.expires_in?Date.now()+o.expires_in*1e3:void 0,n={token:o,expiresAt:t};try{const e=globalThis.logseq;if(e&&typeof e.updateSettings=="function"){const r=e.settings||{},a=Object.assign({},r,{[u]:JSON.stringify(n)});await Promise.resolve(e.updateSettings(a));return}}catch(e){console.warn("logseq storage save failed, falling back to localStorage",e)}localStorage.setItem(u,JSON.stringify(n))}async function v(){try{const t=globalThis.logseq;if(t&&t.settings&&t.settings[u]){const n=t.settings[u];try{return JSON.parse(n)}catch(e){return console.warn("Failed to parse token from logseq.settings",e),null}}}catch(t){console.warn("logseq storage read failed, falling back to localStorage",t)}const o=localStorage.getItem(u);if(!o)return null;try{return JSON.parse(o)}catch(t){return console.warn("Failed to parse token from localStorage",t),null}}async function T(o,t){{const e=await fetch(m,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:o,redirect_uri:p,code_verifier:t})});let r="",a=null;const s=e;if(s&&typeof s.text=="function"){r=await s.text();try{a=JSON.parse(r)}catch{}}else if(s&&typeof s.json=="function"){a=await s.json();try{r=JSON.stringify(a)}catch{r=String(a)}}if(!e.ok){const c=a&&a.error_description?`${a.error}: ${a.error_description}`:`HTTP ${e.status} ${e.statusText}`,l=typeof r=="string"?r.substring(0,2e3):String(r);try{console.error("[googleAuth] backend exchange error",{status:e.status,statusText:e.statusText,body:a||r})}catch{}throw new Error("Backend token exchange failed: "+c+`
`+l)}return a}}let h=null,i=null;function E(o){try{const t=o.data;if(t&&typeof t=="object"){const n=t;if(n.type==="logseq_gcal_code"&&typeof n.code=="string"){const e=n.code;if(h){const r=h;h=null,r(e);return}if(i){const r=i;i=null,r(e);return}}}}catch{}}typeof window<"u"&&typeof window.addEventListener=="function"&&window.addEventListener("message",E);function g(o,t){try{typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(new CustomEvent("gcal:status",{detail:Object.assign({status:o},t||{})}))}catch{}}async function C(o){const t=window.open(o,"_blank","");return t?new Promise(n=>{function e(c){try{const l=c.data;try{console.debug("[googleAuth] postMessage received",l)}catch{}if(l&&typeof l=="object"){const d=l;if(d.type==="logseq_gcal_code"&&typeof d.code=="string"){a();try{t?.close()}catch{}n(d.code)}}}catch{}}function r(){(!t||t.closed)&&(a(),n(null))}function a(){window.removeEventListener("message",e),clearInterval(s)}window.addEventListener("message",e);const s=setInterval(()=>{try{r()}catch{}},500)}):null}function I(o){if(i){const t=i;return i=null,t(o),!0}return!1}async function x(o){const t=new URLSearchParams({client_id:f,refresh_token:o,grant_type:"refresh_token"}),n=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString()});let e="",r=null;const a=n;if(a&&typeof a.text=="function"){e=await a.text();try{r=JSON.parse(e)}catch{}}else if(a&&typeof a.json=="function"){r=await a.json();try{e=JSON.stringify(r)}catch{e=String(r)}}if(!n.ok){const s=r&&r.error_description?`${r.error}: ${r.error_description}`:`HTTP ${n.status} ${n.statusText}`,c=typeof e=="string"?e.substring(0,2e3):String(e);try{console.error("[googleAuth] refresh token error",{status:n.status,statusText:n.statusText,body:r||e})}catch{}throw new Error("Refresh token failed: "+s+`
`+c)}return r}async function O(){const o=new URL("https://accounts.google.com/o/oauth2/v2/auth");try{const t=k(),n=await b(t);localStorage.setItem("gcal_code_verifier",t),o.searchParams.set("client_id",f),o.searchParams.set("redirect_uri",p),o.searchParams.set("response_type","code"),o.searchParams.set("scope",_.join(" ")),o.searchParams.set("code_challenge",n),o.searchParams.set("code_challenge_method","S256"),o.searchParams.set("access_type","offline");let e=null;try{g("awaiting_code"),e=await C(o.toString())}catch{}if(!e&&(window.open(o.toString(),"_blank"),g("awaiting_manual_code"),window.alert('Se a entrega automática falhar, na página de callback clique "Enviar código ao plugin" ou copie o código e cole no plugin.'),e=await new Promise(s=>{i=c=>{i=null,s(c)},setTimeout(()=>{try{const c=window.prompt("Depois de conceder acesso, cole o código de autorização aqui:");if(c)if(i){const l=i;i=null,l(c.trim())}else s(c.trim())}catch{}},100)}),!e))throw new Error("No authorization code provided");g("exchanging");const r=localStorage.getItem("gcal_code_verifier");if(!r)throw new Error("Code verifier not found in storage");const a=await T(e,r);await w(a),g("connected"),localStorage.removeItem("gcal_code_verifier")}catch(t){const n=t instanceof Error?t.message:String(t);try{g("error",{message:n,clientId:f,redirectUri:p})}catch{}try{if(typeof window<"u"&&n.toLowerCase().includes("client secret")){try{console.error("[googleAuth] token exchange failed with client-secret requirement",{clientId:f,redirectUri:p})}catch{}try{window.alert(`Token exchange falhou porque o cliente OAuth requer um client secret. Para desenvolvimento local, crie um OAuth Client do tipo "Desktop app" ou use um client configurado para PKCE (sem client secret).

Passos rápidos:
1. Abra Google Cloud Console → APIs & Services → Credentials.
2. Create Credentials → OAuth client ID → Application type: Desktop app.
3. Copie o Client ID e coloque em .env.local como VITE_GOOGLE_CLIENT_ID.
4. Atualize VITE_GOOGLE_REDIRECT_URI para a URL do seu dev server + /oauth2callback.html e reinicie o dev server.

Debug: clientId=`+f+`
redirectUri=`+p)}catch{}}}catch{}throw t}}async function P(){const o=await v();if(!o)return null;const{token:t,expiresAt:n}=o;if(n&&Date.now()<n-1e4)return t.access_token;if(t.refresh_token)try{const e=await x(t.refresh_token);return e.refresh_token||(e.refresh_token=t.refresh_token),await w(e),e.access_token}catch(e){return console.error("Failed to refresh access token",e),null}return null}async function R(){try{const o=globalThis.logseq;if(o&&typeof o.updateSettings=="function"){const t=o.settings||{},n=Object.assign({},t);delete n[u],await Promise.resolve(o.updateSettings(n))}}catch(o){console.warn("Failed clearing token from logseq settings",o)}try{localStorage.removeItem(u)}catch{}}export{R as clearToken,P as getAccessToken,I as provideAuthCode,O as startGoogleAuth};
